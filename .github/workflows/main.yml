name: Athar App Unified Handler
on:
  repository_dispatch:
    types: [new_video_upload, update_like]

permissions:
  contents: write

jobs:
  process:
    runs-on: ubuntu-latest
    # Ø´Ù„Ù†Ø§ Ø§Ù„Ù€ concurrency Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¹Ø´Ø§Ù† Ù‡ÙŠ Ø§Ù„Ù„ÙŠ Ø¨ØªÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙƒØ´Ù†Ø² Ø§Ù„Ø²ÙŠØ§Ø¯Ø©
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Execute Logic
        env:
          FILE_ID: ${{ github.event.client_payload.file_id }}
          VIDEO_TITLE: ${{ github.event.client_payload.video_title }}
          VIDEO_ID: ${{ github.event.client_payload.video_id }}
          ACTION: ${{ github.event.client_payload.action }}
          EVENT_TYPE: ${{ github.event.action }} # Ø§Ù„ØªØµÙ„ÙŠØ­ Ù‡Ù†Ø§: Ø§Ø³ØªØ®Ø¯Ù… event.action
        run: |
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¨Ø³ÙŠØ· Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØµØ§Ø¯Ù… ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
          sleep $(( RANDOM % 10 ))
          
          if [ "$EVENT_TYPE" == "new_video_upload" ]; then
            echo "ğŸš€ Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯..."
            python update_json.py
          elif [ "$EVENT_TYPE" == "update_like" ]; then
            echo "â¤ï¸ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ù„Ø§ÙŠÙƒØ§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø±Ù‚Ù… $VIDEO_ID..."
            python manage_likes.py "$VIDEO_ID" "$ACTION"
          else
            echo "â“ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø« ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: $EVENT_TYPE"
          fi

      - name: Save Changes with Retry Logic
        run: |
          git config --global user.name 'Athar Bot'
          git config --global user.email 'bot@athar.com'
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø±ÙØ¹ Ø¨Ø´ÙƒÙ„ Ù…ØªÙƒØ±Ø± ÙˆØ°ÙƒÙŠ
          for i in {1..10}; do
            git add videos.json
            # Ù„Ùˆ Ù…ÙÙŠØ´ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ø®Ø±Ø¬ Ø¨Ø³Ù„Ø§Ù…
            git commit -m "Automated Update: ${{ github.event.action }}" || exit 0
            
            # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø±ÙØ¹
            if git pull --rebase -X theirs origin main && git push; then
              echo "âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø±Ù‚Ù… $i"
              exit 0
            else
              echo "âš ï¸ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ..."
              sleep 5
            fi
          done
          exit 1
