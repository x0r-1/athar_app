name: Athar App Unified Handler
on:
  repository_dispatch:
    types: [new_video_upload, update_like]

permissions:
  contents: write

jobs:
  process:
    runs-on: ubuntu-latest
    # Ù…ÙŠØ²Ø© Ø§Ù„Ù€ concurrency Ø¨ØªØ®Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ØªØ³ØªÙ†Ù‰ Ø¨Ø¹Ø¶ Ø¹Ø´Ø§Ù† Ù…ÙŠØ­ØµÙ„Ø´ Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù€ JSON
    concurrency: 
      group: athar-db-update
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Execute Logic
        env:
          # Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„ÙŠ Ø¬Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ù€ Worker
          FILE_ID: ${{ github.event.client_payload.file_id }}
          VIDEO_TITLE: ${{ github.event.client_payload.video_title }}
          VIDEO_ID: ${{ github.event.client_payload.video_id }}
          ACTION: ${{ github.event.client_payload.action }}
        run: |
          if [ "${{ github.event.action }}" == "new_video_upload" ]; then
            echo "ğŸš€ Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯..."
            python update_json.py
          elif [ "${{ github.event.action }}" == "update_like" ]; then
            echo "â¤ï¸ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ù„Ø§ÙŠÙƒØ§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø±Ù‚Ù… $VIDEO_ID..."
            # Ù‡Ù†Ø§ Ø¨Ù†Ù†Ø§Ø¯ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø¨ØªØ§Ø¹Ùƒ Ø§Ù„Ù„ÙŠ Ø§Ø³Ù…Ù‡ manage_likes.py
            python manage_likes.py "$VIDEO_ID" "$ACTION"
          fi

      - name: Save Changes
        run: |
          git config --global user.name 'Athar Bot'
          git config --global user.email 'bot@athar.com'
          git add videos.json
          git commit -m "Automated Update: ${{ github.event.action }}" || exit 0
          
          # Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø°ÙƒÙŠ Ø¹Ø´Ø§Ù† Ù„Ùˆ ÙÙŠÙ‡ ÙƒØ°Ø§ Ø£ÙƒØ´Ù† Ø´ØºØ§Ù„ÙŠÙ† ÙˆØ±Ø§ Ø¨Ø¹Ø¶
          for i in {1..5}; do
            git pull --rebase -X theirs origin main && git push && break || sleep 10;
          done
