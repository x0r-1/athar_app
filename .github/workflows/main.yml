name: Athar App Unified Handler
on:
  repository_dispatch:
    types: [new_video_upload, update_like]

permissions:
  contents: write

concurrency:
  group: athar-lock
  cancel-in-progress: false

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Process Video
        run: |
          git config --global user.name 'Athar Bot'
          git config --global user.email 'bot@athar.com'
          
          # تأكد من سحب آخر التحديثات قبل البدء
          git pull origin main
          
          # 1. إنشاء الملف المؤقت للفيديو (بواسطة الملف الأول)
          if [ "${{ github.event.action }}" == "new_video_upload" ]; then
            python update_json.py
          fi
          
          # 2. تحديث اللايكات (لو الطلب لايك)
          if [ "${{ github.event.action }}" == "update_like" ]; then
            python manage_likes.py "${{ github.event.client_payload.video_id }}" "${{ github.event.client_payload.action }}"
          fi

          # 3. دمج كل الملفات المؤقتة في الملف الرئيسي (بواسطة الملف الجديد)
          python merge_videos.py

          # 4. حفظ ورفع التغييرات
          git add .
          git commit -m "Update Athar Data" || exit 0
          
          for i in {1..10}; do
            git pull --rebase origin main
            git push && break || sleep 5
          done
