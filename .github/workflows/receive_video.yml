name: Athar Video & Like Receiver
on:
  repository_dispatch:
    types: [new_video_upload, update_like]

permissions:
  contents: write

jobs:
  receive:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Create Temp Entry
        run: |
          mkdir -p queue
          EVENT_TYPE="${{ github.event.action }}"
          TIMESTAMP=$(date +%s)
          
          if [ "$EVENT_TYPE" == "new_video_upload" ]; then
            # ÙƒØªØ§Ø¨Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ EOF
            echo "{\"file_id\": \"${{ github.event.client_payload.file_id }}\", \"video_title\": \"${{ github.event.client_payload.video_title }}\", \"timestamp\": $TIMESTAMP}" > "queue/vid_${{ github.event.client_payload.file_id }}.json"
            echo "ğŸš€ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±"
            
          elif [ "$EVENT_TYPE" == "update_like" ]; then
            # ÙƒØªØ§Ø¨Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§ÙŠÙƒ ÙÙŠ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯
            echo "{\"video_id\": \"${{ github.event.client_payload.video_id }}\", \"action\": \"${{ github.event.client_payload.action }}\", \"timestamp\": $TIMESTAMP}" > "queue/like_${{ github.event.client_payload.video_id }}_$RANDOM.json"
            echo "â¤ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ù„Ø§ÙŠÙƒ ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±"
          fi

      - name: Commit & Push to Queue
        run: |
          git config --global user.name 'Athar Receiver'
          git config --global user.email 'bot@athar.com'
          git add queue/
          git commit -m "New entry in queue: ${{ github.event.action }}" || exit 0
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø±ÙØ¹ Ù…Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù†Ø¬Ø§Ø­ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø­Ù…Ø©
          for i in {1..5}; do
            git pull --rebase origin main && git push && break || sleep 5
          done
